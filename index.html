<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒ‰ãƒ©ã‚¯ã‚¨é¢¨RPG - ãƒœã‚¹æˆ¦ã‚·ã‚¹ãƒ†ãƒ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
/* ==========================
   ãƒ‰ãƒ©ã‚¯ã‚¨1é¢¨RPG CSS
   ========================== */

/* ãƒ‰ãƒƒãƒˆãƒ•ã‚©ãƒ³ãƒˆï¼ˆé›°å›²æ°—ï¼‰ */
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

/* å…¨ä½“ */
:root {
  --bg-dark: #000020;
  --bg-blue: #0052cc;
  --window-bg: #002266;
  --border-light: #4488ff;
  --text-white: #ffffff;
  --text-yellow: #ffff00;
  --text-green: #00ff00;
  --text-red: #ff4444;
  --shadow: #000066;
  --boss-purple: #660066;
  --boss-red: #cc0000;
}

* { box-sizing: border-box; }

html, body {
  margin: 0;
  padding: 0;
  background: var(--bg-dark);
  color: var(--text-white);
  font-family: "Press Start 2P", monospace, system-ui, sans-serif;
  line-height: 1.4;
  overflow: hidden;
  height: 100vh;
}

/* ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
#gameScreen {
  display: grid;
  grid-template-columns: 1fr 3fr 1fr;
  grid-template-rows: auto 1fr auto;
  grid-template-areas:
    "gold-status field-area menu"
    "player-status field-area battle-area"
    "message-window message-window message-window";
  height: 100vh;
  gap: 8px;
  padding: 8px;
  background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-blue) 100%);
}

/* ãƒœã‚¹æˆ¦æ™‚ã®èƒŒæ™¯å¤‰æ›´ */
.boss-battle #gameScreen {
  background: linear-gradient(135deg, var(--boss-purple) 0%, var(--boss-red) 100%);
  animation: bossBackground 3s ease-in-out infinite alternate;
}

@keyframes bossBackground {
  0% { filter: brightness(1); }
  100% { filter: brightness(1.2); }
}

/* å·¦ä¸Šï¼šã‚´ãƒ¼ãƒ«ãƒ‰ãƒ»çµŒé¨“å€¤ */
#goldStatus {
  grid-area: gold-status;
  background: var(--window-bg);
  border: 3px solid var(--border-light);
  border-radius: 8px;
  padding: 8px;
  font-size: 10px;
  text-align: center;
  box-shadow: 2px 2px 0 var(--shadow);
}

/* ä¸­å¤®ï¼šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¨ãƒªã‚¢ */
#fieldArea {
  grid-area: field-area;
  display: flex;
  justify-content: center;
  align-items: center;
  background: var(--window-bg);
  border: 3px solid var(--border-light);
  border-radius: 12px;
  box-shadow: 4px 4px 0 var(--shadow);
  position: relative;
}

#map {
  width: 100%;
  max-width: 400px;
  height: auto;
  aspect-ratio: 1;
  border: 2px solid var(--text-white);
  background: #000;
  image-rendering: pixelated;
}

/* å³ä¸Šï¼šãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
#menu {
  grid-area: menu;
  background: var(--window-bg);
  border: 3px solid var(--border-light);
  border-radius: 8px;
  padding: 12px 8px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  box-shadow: 2px 2px 0 var(--shadow);
}

.menu-btn {
  padding: 8px;
  background: var(--bg-dark);
  border: 2px solid var(--border-light);
  border-radius: 4px;
  color: var(--text-white);
  font-size: 10px;
  cursor: pointer;
  transition: all 0.1s;
  box-shadow: 1px 1px 0 var(--shadow);
  touch-action: manipulation;
}

.menu-btn:hover {
  background: var(--border-light);
  color: var(--bg-dark);
}

.menu-btn:active {
  transform: translate(1px, 1px);
  box-shadow: none;
}

/* å·¦ä¸‹ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
#playerStatus {
  grid-area: player-status;
  background: var(--window-bg);
  border: 3px solid var(--border-light);
  border-radius: 8px;
  padding: 12px;
  font-size: 10px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  box-shadow: 2px 2px 0 var(--shadow);
}

.status-row {
  display: flex;
  justify-content: space-between;
}

.status-label {
  color: var(--text-yellow);
}

.status-value {
  color: var(--text-white);
}

/* å³ä¸‹ï¼šæˆ¦é—˜ã‚¨ãƒªã‚¢ï¼ˆé€šå¸¸ã¯éè¡¨ç¤ºï¼‰ */
#battleArea {
  grid-area: battle-area;
  background: var(--window-bg);
  border: 3px solid var(--border-light);
  border-radius: 8px;
  padding: 16px;
  display: none;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  box-shadow: 2px 2px 0 var(--shadow);
}

/* ãƒœã‚¹æˆ¦æ™‚ã®æˆ¦é—˜ã‚¨ãƒªã‚¢ */
.boss-battle #battleArea {
  border-color: var(--boss-red);
  animation: bossBorder 2s ease-in-out infinite alternate;
}

@keyframes bossBorder {
  0% { box-shadow: 2px 2px 0 var(--shadow); }
  100% { box-shadow: 4px 4px 0 var(--boss-red); }
}

/* æˆ¦é—˜æ™‚ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼è¡¨ç¤º */
#enemyContainer {
  text-align: center;
  background: var(--bg-dark);
  border: 2px solid var(--border-light);
  border-radius: 8px;
  padding: 16px;
  width: 100%;
  position: relative;
}

/* ãƒœã‚¹å°‚ç”¨ã‚³ãƒ³ãƒ†ãƒŠ */
.boss-battle #enemyContainer {
  border-color: var(--boss-red);
  background: linear-gradient(45deg, var(--bg-dark), var(--boss-purple));
}

#enemySprite {
  width: 80px;
  height: 80px;
  margin: 8px auto;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* ãƒœã‚¹å°‚ç”¨ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆï¼ˆå¤§ããè¡¨ç¤ºï¼‰ */
.boss-battle #enemySprite {
  width: 120px;
  height: 120px;
  animation: bossFloat 3s ease-in-out infinite;
}

@keyframes bossFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

#enemyStatus {
  font-size: 10px;
  color: var(--text-green);
  margin-top: 8px;
}

/* ãƒœã‚¹å°‚ç”¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
.boss-battle #enemyStatus {
  color: var(--text-red);
  font-size: 12px;
  animation: bossStatusPulse 2s ease-in-out infinite;
}

@keyframes bossStatusPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* æˆ¦é—˜ã‚³ãƒãƒ³ãƒ‰ */
#commands {
  display: flex;
  flex-direction: column;
  gap: 6px;
  width: 100%;
}

.cmd-btn {
  padding: 12px;
  background: linear-gradient(180deg, var(--border-light), var(--bg-blue));
  border: 2px solid var(--text-white);
  border-radius: 6px;
  color: var(--text-white);
  font-size: 12px;
  cursor: pointer;
  transition: all 0.1s;
  box-shadow: 2px 2px 0 var(--shadow);
}

.cmd-btn:hover {
  background: linear-gradient(180deg, var(--text-white), var(--border-light));
  color: var(--bg-dark);
}

.cmd-btn:active {
  transform: translate(1px, 1px);
  box-shadow: 1px 1px 0 var(--shadow);
  touch-action: manipulation;
}

/* ãƒœã‚¹æˆ¦å°‚ç”¨ã‚³ãƒãƒ³ãƒ‰ãƒœã‚¿ãƒ³ */
.boss-battle .cmd-btn {
  border-color: var(--boss-red);
  background: linear-gradient(180deg, var(--boss-red), var(--boss-purple));
}

.boss-battle .cmd-btn:hover {
  background: linear-gradient(180deg, var(--text-white), var(--boss-red));
}

/* ä¸‹éƒ¨ï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ */
#messageWindow {
  grid-area: message-window;
  background: var(--window-bg);
  border: 3px solid var(--border-light);
  border-radius: 8px;
  padding: 16px;
  font-size: 12px;
  min-height: 80px;
  display: flex;
  align-items: center;
  box-shadow: 2px 2px 0 var(--shadow);
  color: var(--text-white);
}

/* ãƒœã‚¹æˆ¦æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ */
.boss-battle #messageWindow {
  border-color: var(--boss-red);
  background: linear-gradient(90deg, var(--window-bg), var(--boss-purple));
}

#battleLog {
  width: 100%;
  text-align: left;
}

/* ãƒ¢ãƒã‚¤ãƒ«æ“ä½œãƒ‘ãƒƒãƒ‰ */
#mobileControls {
  position: fixed;
  bottom: 120px;
  right: 16px;
  display: none;
  z-index: 1000;
  transform: scale(1.5);
  transform-origin: bottom right;
}

.control-row {
  display: flex;
  justify-content: center;
  gap: 4px;
  margin: 2px 0;
}

.dir-btn {
  width: 50px;
  height: 50px;
  border: 2px solid var(--border-light);
  border-radius: 8px;
  background: var(--window-bg);
  color: var(--text-white);
  font-size: 16px;
  cursor: pointer;
  transition: all 0.1s;
  box-shadow: 1px 1px 0 var(--shadow);
  touch-action: manipulation;
}

.dir-btn:active {
  background: var(--border-light);
  color: var(--bg-dark);
  transform: translate(1px, 1px);
  box-shadow: none;
}

/* æˆ¦é—˜ãƒ¢ãƒ¼ãƒ‰æ™‚ã®èª¿æ•´ */
.battle-mode #fieldArea {
  display: none;
}

.battle-mode #battleArea {
  display: flex;
  grid-area: field-area;
}

.battle-mode #goldStatus,
.battle-mode #menu {
  opacity: 0.7;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width: 768px) {
  #gameScreen {
    grid-template-columns: 1fr;
    grid-template-rows: auto auto 1fr auto auto;
    grid-template-areas:
      "gold-status"
      "menu"
      "field-area"
      "player-status"
      "message-window";
    gap: 4px;
    padding: 4px;
  }
  
  .battle-mode #gameScreen {
    grid-template-areas:
      "gold-status"
      "menu"
      "battle-area"
      "player-status"
      "message-window";
  }
  
  #mobileControls {
    display: block;
    position: fixed;
    bottom: 16px;
    right: 16px;
  }
  
  #goldStatus, #menu, #playerStatus {
    font-size: 8px;
  }
  
  .cmd-btn {
    font-size: 10px;
    padding: 8px;
  }
}

@media (max-width: 480px) {
  #gameScreen {
    padding: 2px;
    gap: 2px;
  }
  
  .dir-btn {
    width: 40px;
    height: 40px;
    font-size: 14px;
  }
  
  #messageWindow {
    min-height: 60px;
    padding: 8px;
    font-size: 10px;
  }
}

/* ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ */
@media (hover: none) and (pointer: coarse) {
  #mobileControls {
    display: block;
  }
}
  </style>
</head>
<body>
  <div id="gameScreen">
    <!-- å·¦ä¸Šï¼šã‚´ãƒ¼ãƒ«ãƒ‰ãƒ»çµŒé¨“å€¤è¡¨ç¤º -->
    <div id="goldStatus">
      <div class="status-row">
        <span class="status-label">GOLD</span>
        <span id="goldValue" class="status-value">0</span>
      </div>
      <div class="status-row">
        <span class="status-label">EXP</span>
        <span id="expValue" class="status-value">0</span>
      </div>
    </div>

    <!-- ä¸­å¤®ï¼šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¨ãƒªã‚¢ -->
    <div id="fieldArea">
      <canvas id="map" width="320" height="320" aria-label="field"></canvas>
    </div>

    <!-- å³ä¸Šï¼šãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div id="menu">
      <button class="menu-btn" onclick="showStatus()">ã¤ã‚ˆã•</button>
      <button class="menu-btn" onclick="showItems()">ã©ã†ã</button>
      <button class="menu-btn" onclick="showMagic()">ã˜ã‚…ã‚‚ã‚“</button>
      <button class="menu-btn" onclick="saveGame()">ãã‚ã</button>
    </div>

    <!-- å·¦ä¸‹ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
    <div id="playerStatus">
      <div class="status-row">
        <span class="status-label">ã‚†ã†ã—ã‚ƒ</span>
        <span class="status-label">LV.<span id="levelValue">1</span></span>
      </div>
      <div class="status-row">
        <span class="status-label">HP</span>
        <span class="status-value"><span id="hpValue">30</span>/<span id="maxHpValue">30</span></span>
      </div>
      <div class="status-row">
        <span class="status-label">MP</span>
        <span class="status-value"><span id="mpValue">10</span>/<span id="maxMpValue">10</span></span>
      </div>
    </div>

    <!-- å³ä¸‹ï¼šæˆ¦é—˜ã‚¨ãƒªã‚¢ï¼ˆé€šå¸¸ã¯éè¡¨ç¤ºï¼‰ -->
    <div id="battleArea">
      <div id="enemyContainer">
        <div id="enemyArea"></div>
        <div id="enemySprite"></div>
        <div id="enemyStatus"></div>
      </div>
      
      <div id="commands">
        <button id="attackBtn" class="cmd-btn">ã“ã†ã’ã</button>
        <button id="magicBtn" class="cmd-btn">ã˜ã‚…ã‚‚ã‚“</button>
        <button id="runBtn" class="cmd-btn">ã«ã’ã‚‹</button>
      </div>
    </div>

    <!-- ä¸‹éƒ¨ï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ -->
    <div id="messageWindow">
      <div id="battleLog">ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç§»å‹•ã—ã¦ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’æ¢ãã†ï¼</div>
    </div>
  </div>

  <!-- ãƒ¢ãƒã‚¤ãƒ«æ“ä½œï¼ˆä»»æ„ï¼‰ -->
  <div id="mobileControls" aria-label="mobile-controls">
    <div class="control-row">
      <button class="dir-btn" data-dir="up" aria-label="up">â†‘</button>
    </div>
    <div class="control-row">
      <button class="dir-btn" data-dir="left" aria-label="left">â†</button>
      <button class="dir-btn" data-dir="down" aria-label="down">â†“</button>
      <button class="dir-btn" data-dir="right" aria-label="right">â†’</button>
    </div>
  </div>

  <script>
// ==========================
// ãƒ‰ãƒ©ã‚¯ã‚¨é¢¨RPG script.js - ãƒœã‚¹æˆ¦ã‚·ã‚¹ãƒ†ãƒ ä»˜ã
// ==========================

// --------- åŸºæœ¬å®šç¾©ï¼ˆã‚¿ã‚¤ãƒ«ãƒ»ãƒãƒƒãƒ—ï¼‰ ---------
const TILE_SIZE = 64;
const MAP_W = 5;
const MAP_H = 5;

// ã‚¿ã‚¤ãƒ«ç¨®åˆ¥ï¼ˆæ•°å€¤ã§ç®¡ç†ï¼‰
const T = {
  GRASS: 0,
  FOREST: 1,
  WATER: 2,
  VILLAGE: 3,
  CASTLE: 4,
  DESERT: 5,
  MOUNTAIN: 6,
  BOSS_CASTLE: 7  // ãƒœã‚¹åŸè¿½åŠ 
};

// åœ°å½¢ã”ã¨ã®è‰²ï¼ˆãƒ™ãƒ¼ã‚¹ï¼‰
const TILE_COLORS = {
  [T.GRASS]:   "#1f8f2e",
  [T.FOREST]:  "#0f5f20",
  [T.WATER]:   "#1173c2",
  [T.VILLAGE]: "#3a2a15",
  [T.CASTLE]:  "#666666",
  [T.DESERT]:  "#c8b26a",
  [T.MOUNTAIN]:"#7b4a2b",
  [T.BOSS_CASTLE]: "#660000"  // ãƒœã‚¹åŸã¯èµ¤é»’
};

// --------- DOMå–å¾— ---------
const canvas = document.getElementById("map");
const ctx = canvas.getContext("2d");

const gameScreen = document.getElementById("gameScreen");
const fieldArea = document.getElementById("fieldArea");
const battleArea = document.getElementById("battleArea");

const enemyArea = document.getElementById("enemyArea");
const enemySprite = document.getElementById("enemySprite");
const enemyStatus = document.getElementById("enemyStatus");
const commands = document.getElementById("commands");
const battleLog = document.getElementById("battleLog");
// ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ™‚ã«è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
const FIELD_MESSAGE = "ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç§»å‹•ã—ã¦ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’æ¢ãã†ï¼";

const goldValue = document.getElementById("goldValue");
const expValue = document.getElementById("expValue");
const levelValue = document.getElementById("levelValue");
const hpValue = document.getElementById("hpValue");
const maxHpValue = document.getElementById("maxHpValue");
const mpValue = document.getElementById("mpValue");
const maxMpValue = document.getElementById("maxMpValue");

// --------- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ---------
const player = {
  x: 2, y: 2,
  hp: 30, maxHp: 30,
  mp: 10, maxMp: 10,
  atk: 6, def: 2,
  level: 1,
  exp: 0, nextExp: 20,
  gold: 0,
  defeatedBosses: []  // å€’ã—ãŸãƒœã‚¹ã‚’è¨˜éŒ²
};

// --------- ãƒãƒƒãƒ—ï¼ˆ2åˆ— Ã— 3è¡Œ = 6é¢ï¼‰å®Œå…¨ä¿®æ­£ç‰ˆ ---------
const m11 = [
  [T.GRASS, T.GRASS,  T.FOREST, T.FOREST, T.VILLAGE],    // å³ä¸Šã«æ‘
  [T.GRASS, T.GRASS,  T.FOREST, T.FOREST, T.GRASS ],     
  [T.GRASS, T.GRASS,  T.GRASS,  T.GRASS,  T.GRASS ],     
  [T.GRASS, T.FOREST, T.FOREST, T.GRASS,  T.GRASS ],     
  [T.DESERT,T.DESERT, T.GRASS,  T.GRASS,  T.CASTLE]      // å³ä¸‹ã«åŸ
];

const m12 = [
  [T.WATER, T.WATER,  T.GRASS,  T.GRASS,  T.GRASS ],     
  [T.WATER, T.GRASS,  T.GRASS,  T.FOREST, T.FOREST],     
  [T.GRASS, T.GRASS,  T.GRASS,  T.GRASS,  T.GRASS ],     
  [T.FOREST,T.FOREST, T.GRASS,  T.BOSS_CASTLE,T.BOSS_CASTLE], // é­”ç‹åŸ
  [T.GRASS, T.GRASS,  T.GRASS,  T.BOSS_CASTLE,T.BOSS_CASTLE]  // é­”ç‹åŸ
];

const m21 = [
  [T.FOREST,T.FOREST, T.FOREST, T.GRASS,  T.GRASS ],     
  [T.FOREST,T.VILLAGE,T.GRASS,  T.GRASS,  T.GRASS ],     // å·¦ä¸Šã«æ‘
  [T.FOREST,T.GRASS,  T.GRASS,  T.GRASS,  T.DESERT],     
  [T.FOREST,T.GRASS,  T.GRASS,  T.GRASS,  T.DESERT],     
  [T.GRASS, T.GRASS,  T.GRASS,  T.GRASS,  T.CASTLE]      // å³ä¸‹ã«åŸ
];

const m22 = [
  [T.CASTLE,T.CASTLE, T.GRASS,  T.GRASS,  T.GRASS ],     // å·¦ä¸Šã«åŸ
  [T.CASTLE,T.CASTLE, T.GRASS,  T.FOREST, T.FOREST],     // å·¦ä¸Šã«åŸ
  [T.GRASS, T.GRASS,  T.GRASS,  T.FOREST, T.FOREST],     
  [T.GRASS, T.GRASS,  T.GRASS,  T.GRASS,  T.GRASS ],     
  [T.GRASS, T.GRASS,  T.VILLAGE,T.GRASS,  T.GRASS ]      // ä¸‹ä¸­å¤®ã«æ‘
];

const m31 = [
  [T.GRASS, T.GRASS,  T.GRASS,  T.GRASS,  T.GRASS ],     
  [T.GRASS, T.FOREST, T.FOREST, T.GRASS,  T.GRASS ],     
  [T.GRASS, T.GRASS,  T.GRASS,  T.GRASS,  T.GRASS ],     
  [T.VILLAGE,T.GRASS, T.MOUNTAIN,T.MOUNTAIN,T.GRASS ],   // å·¦ä¸‹ã«æ‘
  [T.CASTLE,T.CASTLE, T.MOUNTAIN,T.GRASS,  T.GRASS ]     // å·¦ä¸‹ã«åŸ
];

const m32 = [
  [T.GRASS, T.GRASS,  T.GRASS,  T.GRASS,  T.GRASS ],     
  [T.FOREST,T.FOREST, T.FOREST, T.FOREST, T.FOREST],     
  [T.GRASS, T.GRASS,  T.GRASS,  T.GRASS,  T.GRASS ],     
  [T.GRASS, T.DESERT, T.DESERT, T.VILLAGE,T.VILLAGE],    // å³ä¸‹ã«æ‘
  [T.BOSS_CASTLE,T.BOSS_CASTLE,T.DESERT,T.CASTLE,T.CASTLE] // å·¦ä¸‹ã«é­”ç‹åŸã€å³ä¸‹ã«åŸ
];

const WORLD = [
  [m11, m12],
  [m21, m22],
  [m31, m32]
];

let mapRow = 0;
let mapCol = 0;
let mapData = WORLD[mapRow][mapCol];

// --------- æ‘ãƒ»åŸãƒ»ãƒœã‚¹åŸã®SVGç”»åƒåŒ– ---------
function svgVillage() {
  return `
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
    <rect x="1" y="7" width="6" height="6" fill="#c49a6c"/>
    <rect x="1" y="5" width="6" height="2" fill="#8b0000"/>
    <rect x="3" y="9" width="2" height="4" fill="#5b3a29"/>
    <rect x="9" y="6" width="6" height="7" fill="#c49a6c"/>
    <rect x="9" y="5" width="6" height="2" fill="#b22222"/>
    <rect x="11" y="9" width="2" height="4" fill="#5b3a29"/>
  </svg>`;
}

function svgCastle() {
  return `
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
    <rect x="0" y="6" width="4" height="9" fill="#6e6e6e"/>
    <rect x="12" y="6" width="4" height="9" fill="#6e6e6e"/>
    <rect x="4" y="8" width="8" height="7" fill="#808080"/>
    <rect x="6" y="11" width="4" height="4" fill="#000"/>
    <rect x="1" y="5" width="2" height="1" fill="#d00"/>
    <rect x="13" y="5" width="2" height="1" fill="#06f"/>
  </svg>`;
}

function svgBossCastle() {
  return `
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
    <rect x="0" y="5" width="4" height="10" fill="#330000"/>
    <rect x="12" y="5" width="4" height="10" fill="#330000"/>
    <rect x="4" y="7" width="8" height="8" fill="#660000"/>
    <rect x="6" y="10" width="4" height="5" fill="#000"/>
    <rect x="1" y="4" width="2" height="2" fill="#ff0000"/>
    <rect x="13" y="4" width="2" height="2" fill="#ff0000"/>
    <rect x="7" y="2" width="2" height="3" fill="#ff6600"/>
    <rect x="2" y="1" width="1" height="2" fill="#660000"/>
    <rect x="6" y="0" width="1" height="2" fill="#660000"/>
    <rect x="9" y="0" width="1" height="2" fill="#660000"/>
    <rect x="13" y="1" width="1" height="2" fill="#660000"/>
  </svg>`;
}

const villageImg = new Image();
villageImg.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svgVillage());
const castleImg = new Image();
castleImg.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svgCastle());
const bossCastleImg = new Image();
bossCastleImg.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svgBossCastle());

// --------- ãƒãƒƒãƒ—æç”» ---------
function drawMap() {
  if (!ctx) return;
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  for (let y = 0; y < MAP_H; y++) {
    for (let x = 0; x < MAP_W; x++) {
      const tile = mapData[y][x];
      drawTile(x, y, tile);
    }
  }

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆé»„è‰²ã„å››è§’ï¼‰
  ctx.fillStyle = "#ffd800";
  ctx.strokeStyle = "#000";
  ctx.lineWidth = 2;
  const px = player.x * TILE_SIZE + 12;
  const py = player.y * TILE_SIZE + 12;
  ctx.fillRect(px, py, TILE_SIZE - 24, TILE_SIZE - 24);
  ctx.strokeRect(px, py, TILE_SIZE - 24, TILE_SIZE - 24);
}

// å„ã‚¿ã‚¤ãƒ«ã®è¡¨ç¾ï¼ˆ8bitç°¡æ˜“ï¼‰
function drawTile(tx, ty, tile) {
  const px = tx * TILE_SIZE;
  const py = ty * TILE_SIZE;

  // ãƒ™ãƒ¼ã‚¹
  ctx.fillStyle = TILE_COLORS[tile] || "#000";
  ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);

  // æ¨¡æ§˜
  switch(tile) {
    case T.GRASS: {
      // æ˜ã‚‹ã„ç‚¹ã§è‰ã£ã½ã•
      ctx.fillStyle = "rgba(255,255,255,0.1)";
      for (let i = 0; i < 8; i++) {
        const rx = px + Math.random() * TILE_SIZE;
        const ry = py + Math.random() * TILE_SIZE;
        ctx.fillRect(rx, ry, 3, 1);
      }
      break;
    }
    case T.MOUNTAIN: {
      // ä¸‰è§’å½¢ã®å±±
      ctx.fillStyle = "#5a331e";
      ctx.beginPath();
      ctx.moveTo(px + 12, py + TILE_SIZE - 8);
      ctx.lineTo(px + TILE_SIZE / 2, py + 8);
      ctx.lineTo(px + TILE_SIZE - 12, py + TILE_SIZE - 8);
      ctx.closePath();
      ctx.fill();
      // é›ª
      ctx.fillStyle = "#ffffff";
      ctx.beginPath();
      ctx.moveTo(px + TILE_SIZE / 2, py + 8);
      ctx.lineTo(px + TILE_SIZE / 2 - 6, py + 18);
      ctx.lineTo(px + TILE_SIZE / 2 + 6, py + 18);
      ctx.closePath();
      ctx.fill();
      break;
    }
    case T.VILLAGE: {
      // ä¸‹åœ°ã¯è‰
      ctx.fillStyle = TILE_COLORS[T.GRASS];
      ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
      // æ‘ã‚¢ã‚¤ã‚³ãƒ³
      if (villageImg.complete) {
        ctx.drawImage(villageImg, px + 8, py + 8, TILE_SIZE - 16, TILE_SIZE - 16);
      }
      break;
    }
    case T.CASTLE: {
      // ä¸‹åœ°ã¯çŸ³
      ctx.fillStyle = "#7b7b7b";
      ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
      // åŸã‚¢ã‚¤ã‚³ãƒ³
      if (castleImg.complete) {
        ctx.drawImage(castleImg, px + 8, py + 6, TILE_SIZE - 16, TILE_SIZE - 16);
      }
      break;
    }
    case T.BOSS_CASTLE: {
      // ãƒœã‚¹åŸã®ä¸‹åœ°ã¯æš—ã„çŸ³
      ctx.fillStyle = "#333333";
      ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
      // ä¸æ°—å‘³ãªã‚ªãƒ¼ãƒ©åŠ¹æœ
      ctx.fillStyle = "rgba(255,0,0,0.2)";
      for (let i = 0; i < 6; i++) {
        ctx.beginPath();
        ctx.arc(px + 32, py + 32, 20 + i * 4, 0, Math.PI * 2);
        ctx.fill();
      }
      // ãƒœã‚¹åŸã‚¢ã‚¤ã‚³ãƒ³
      if (bossCastleImg.complete) {
        ctx.drawImage(bossCastleImg, px + 8, py + 4, TILE_SIZE - 16, TILE_SIZE - 16);
      }
      break;
    }
  }

  // ã‚¿ã‚¤ãƒ«å¢ƒç•Œã®ç´°ã„ç·š
  ctx.strokeStyle = "rgba(0,0,0,0.2)";
  ctx.lineWidth = 1;
  ctx.strokeRect(px + 0.5, py + 0.5, TILE_SIZE - 1, TILE_SIZE - 1);
}

// --------- æ•µãƒ‡ãƒ¼ã‚¿ ---------
const ENEMIES = {
  slime: { id: "slime", name: "ã‚¹ãƒ©ã‚¤ãƒ ", hp: 10, atk: 3, exp: 5, gold: 3 },
  goblin: { id: "goblin", name: "ã‚´ãƒ–ãƒªãƒ³", hp: 16, atk: 4, exp: 8, gold: 6 },
  mushroom: { id: "mushroom", name: "æ¯’ãã®ã“", hp: 14, atk: 4, exp: 10, gold: 7 },
  demon: { id: "demon", name: "é­”æ—", hp: 22, atk: 6, exp: 16, gold: 12 },
  octopus: { id: "octopus", name: "ãŸã“å…¥é“", hp: 24, atk: 6, exp: 18, gold: 14 },
  dragon: { id: "dragon", name: "ãƒ‰ãƒ©ã‚´ãƒ³", hp: 40, atk: 9, exp: 35, gold: 30 },
  devil: { id: "devil", name: "æ‚ªé­”", hp: 28, atk: 7, exp: 22, gold: 18 }
};

// ãƒœã‚¹æ•µãƒ‡ãƒ¼ã‚¿
const BOSSES = {
  darkLord: { 
    id: "darkLord", name: "é­”ç‹ã‚¶ãƒ©ã‚­ã‚¨ãƒ«", hp: 80, maxHp: 80, atk: 12, def: 3, exp: 100, gold: 200,
    specialAttack: "æš—é»’ã®åµ", specialDamage: 18, isBoss: true
  },
  shadowDragon: { 
    id: "shadowDragon", name: "å½±ã®ç«œç‹", hp: 120, maxHp: 120, atk: 15, def: 4, exp: 150, gold: 300,
    specialAttack: "ã‚·ãƒ£ãƒ‰ã‚¦ãƒ–ãƒ¬ã‚¹", specialDamage: 25, isBoss: true
  }
};

// ãƒœã‚¹ä½ç½®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆå®Œå…¨ä¿®æ­£ç‰ˆï¼‰
const BOSS_LOCATIONS = {
  // å³ä¸Šãƒãƒƒãƒ—ï¼ˆm12ï¼‰ã®é­”ç‹åŸ - é­”ç‹ã‚¶ãƒ©ã‚­ã‚¨ãƒ«
  "0_1_3_3": "darkLord",     // (3,3)
  "0_1_4_3": "darkLord",     // (4,3) 
  "0_1_3_4": "darkLord",     // (3,4)
  "0_1_4_4": "darkLord",     // (4,4)
  
  // å·¦ä¸‹ãƒãƒƒãƒ—ï¼ˆm32ï¼‰ã®é­”ç‹åŸ - å½±ã®ç«œç‹  
  "2_1_0_4": "shadowDragon", // (0,4)
  "2_1_1_4": "shadowDragon"  // (1,4)
};

// æ•µãƒ‰ãƒƒãƒˆçµµï¼ˆSVGæ–‡å­—åˆ—ï¼‰
const ENEMY_SVG = {
  slime: `
    <svg width="80" height="80" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
      <rect width="16" height="16" fill="#000020"/>
      <circle cx="8" cy="10" r="5" fill="#4da6ff"/>
      <circle cx="8" cy="9" r="3" fill="#66b3ff"/>
      <rect x="5" y="8" width="2" height="2" fill="#fff"/>
      <rect x="9" y="8" width="2" height="2" fill="#fff"/>
      <rect x="6" y="9" width="1" height="1" fill="#000"/>
      <rect x="9" y="9" width="1" height="1" fill="#000"/>
    </svg>`,
  goblin: `
    <svg width="80" height="80" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
      <rect width="16" height="16" fill="#000020"/>
      <rect x="4" y="4" width="8" height="8" fill="#4d7c0f"/>
      <rect x="5" y="6" width="2" height="2" fill="#fff"/>
      <rect x="9" y="6" width="2" height="2" fill="#fff"/>
      <rect x="6" y="7" width="1" height="1" fill="#000"/>
      <rect x="10" y="7" width="1" height="1" fill="#000"/>
      <rect x="7" y="9" width="2" height="1" fill="#dc2626"/>
      <rect x="2" y="3" width="2" height="3" fill="#4d7c0f"/>
      <rect x="12" y="3" width="2" height="3" fill="#4d7c0f"/>
    </svg>`,
  mushroom: `
    <svg width="80" height="80" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
      <rect width="16" height="16" fill="#000020"/>
      <ellipse cx="8" cy="6" rx="5" ry="3" fill="#7c3aed"/>
      <rect x="3" y="6" width="2" height="1" fill="#fff"/>
      <rect x="11" y="6" width="2" height="1" fill="#fff"/>
      <rect x="7" y="9" width="2" height="5" fill="#f3f4f6"/>
      <rect x="6" y="14" width="4" height="1" fill="#d1d5db"/>
    </svg>`,
  demon: `
    <svg width="80" height="80" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
      <rect width="16" height="16" fill="#000020"/>
      <rect x="4" y="4" width="8" height="8" fill="#7f1d1d"/>
      <rect x="5" y="6" width="2" height="2" fill="#fef08a"/>
      <rect x="9" y="6" width="2" height="2" fill="#fef08a"/>
      <rect x="6" y="7" width="1" height="1" fill="#dc2626"/>
      <rect x="9" y="7" width="1" height="1" fill="#dc2626"/>
      <rect x="7" y="9" width="2" height="1" fill="#fff"/>
      <rect x="2" y="2" width="2" height="4" fill="#7f1d1d"/>
      <rect x="12" y="2" width="2" height="4" fill="#7f1d1d"/>
    </svg>`,
  octopus: `
    <svg width="80" height="80" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
      <rect width="16" height="16" fill="#000020"/>
      <circle cx="8" cy="7" r="4" fill="#ec4899"/>
      <rect x="5" y="6" width="2" height="2" fill="#fff"/>
      <rect x="9" y="6" width="2" height="2" fill="#fff"/>
      <rect x="6" y="7" width="1" height="1" fill="#000"/>
      <rect x="10" y="7" width="1" height="1" fill="#000"/>
      <rect x="4" y="11" width="1" height="4" fill="#ec4899"/>
      <rect x="6" y="12" width="1" height="3" fill="#ec4899"/>
      <rect x="9" y="12" width="1" height="3" fill="#ec4899"/>
      <rect x="11" y="11" width="1" height="4" fill="#ec4899"/>
    </svg>`,
  dragon: `
    <svg width="80" height="80" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
      <rect width="16" height="16" fill="#000020"/>
      <rect x="3" y="4" width="10" height="8" fill="#166534"/>
      <rect x="5" y="6" width="2" height="2" fill="#dc2626"/>
      <rect x="9" y="6" width="2" height="2" fill="#dc2626"/>
      <rect x="6" y="7" width="1" height="1" fill="#000"/>
      <rect x="10" y="7" width="1" height="1" fill="#000"/>
      <rect x="6" y="9" width="4" height="2" fill="#dc2626"/>
      <rect x="1" y="2" width="3" height="2" fill="#166534"/>
      <rect x="12" y="2" width="3" height="2" fill="#166534"/>
    </svg>`,
  devil: `
    <svg width="80" height="80" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
      <rect width="16" height="16" fill="#000020"/>
      <rect x="4" y="4" width="8" height="8" fill="#581c87"/>
      <rect x="5" y="6" width="2" height="2" fill="#fff"/>
      <rect x="9" y="6" width="2" height="2" fill="#fff"/>
      <rect x="6" y="7" width="1" height="1" fill="#dc2626"/>
      <rect x="10" y="7" width="1" height="1" fill="#dc2626"/>
      <rect x="7" y="9" width="2" height="1" fill="#dc2626"/>
      <rect x="2" y="1" width="2" height="3" fill="#581c87"/>
      <rect x="12" y="1" width="2" height="3" fill="#581c87"/>
    </svg>`,
  // ãƒœã‚¹SVG
  darkLord: `
    <svg width="120" height="120" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
      <rect width="20" height="20" fill="#000020"/>
      <rect x="6" y="4" width="8" height="12" fill="#330033"/>
      <rect x="5" y="6" width="3" height="3" fill="#ff0066"/>
      <rect x="12" y="6" width="3" height="3" fill="#ff0066"/>
      <rect x="6" y="7" width="1" height="1" fill="#000"/>
      <rect x="13" y="7" width="1" height="1" fill="#000"/>
      <rect x="8" y="10" width="4" height="2" fill="#ff0000"/>
      <rect x="3" y="2" width="3" height="5" fill="#330033"/>
      <rect x="14" y="2" width="3" height="5" fill="#330033"/>
      <rect x="4" y="16" width="12" height="2" fill="#660066"/>
      <rect x="2" y="0" width="2" height="4" fill="#ff0066"/>
      <rect x="16" y="0" width="2" height="4" fill="#ff0066"/>
    </svg>`,
  shadowDragon: `
    <svg width="120" height="120" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
      <rect width="20" height="20" fill="#000020"/>
      <rect x="2" y="6" width="16" height="10" fill="#1a0033"/>
      <rect x="5" y="8" width="3" height="3" fill="#9900cc"/>
      <rect x="12" y="8" width="3" height="3" fill="#9900cc"/>
      <rect x="6" y="9" width="1" height="1" fill="#fff"/>
      <rect x="13" y="9" width="1" height="1" fill="#fff"/>
      <rect x="7" y="12" width="6" height="2" fill="#cc0066"/>
      <rect x="0" y="4" width="4" height="3" fill="#1a0033"/>
      <rect x="16" y="4" width="4" height="3" fill="#1a0033"/>
      <rect x="1" y="0" width="2" height="3" fill="#1a0033"/>
      <rect x="17" y="0" width="2" height="3" fill="#1a0033"/>
      <rect x="8" y="2" width="4" height="2" fill="#9900cc"/>
    </svg>`
};

// --------- æˆ¦é—˜åˆ¶å¾¡ ---------
let inBattle = false;
let enemy = null;
let isBossBattle = false;

// å†…éƒ¨ãƒ­ã‚°ï¼ˆä¿æŒã¯è¤‡æ•°ã€è¡¨ç¤ºã¯1è¡Œï¼‰
const logs = [];
function setLog(msg) {
  logs.push(msg);
  battleLog.innerText = msg;
}

// UIè¡¨ç¤º/éè¡¨ç¤º
function showBattleUI(flag) {
  if (flag) {
    gameScreen.classList.add('battle-mode');
    if (isBossBattle) {
      gameScreen.classList.add('boss-battle');
    }
    enemyArea.style.display = "block";
    enemySprite.style.display = "flex";
    enemyStatus.style.display = "block";
    commands.style.display = "flex";
  } else {
    gameScreen.classList.remove('battle-mode', 'boss-battle');
    enemyArea.style.display = "none";
    enemySprite.style.display = "none";
    enemyStatus.style.display = "none";
    commands.style.display = "none";
    isBossBattle = false;
  }
}

// ãƒœã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆä¿®æ­£ï¼‰
function getBossAtLocation() {
  const key = `${mapRow}_${mapCol}_${player.x}_${player.y}`;
  console.log("ãƒœã‚¹ä½ç½®ãƒã‚§ãƒƒã‚¯:", key); // ãƒ‡ãƒãƒƒã‚°ç”¨
  const bossId = BOSS_LOCATIONS[key];
  if (bossId && !player.defeatedBosses.includes(bossId)) {
    console.log("ãƒœã‚¹ç™ºè¦‹:", bossId); // ãƒ‡ãƒãƒƒã‚°ç”¨
    return { ...BOSSES[bossId] };
  }
  console.log("ãƒœã‚¹ãªã—"); // ãƒ‡ãƒãƒƒã‚°ç”¨
  return null;
}

// æ•µãƒ©ãƒ³ãƒ€ãƒ ï¼ˆåœ°å½¢ã§é‡ã¿ä»˜ã‘å¯ï¼šç°¡æ˜“ï¼‰
function pickEnemyByTile(tile) {
  const poolGrass = ["slime", "goblin", "mushroom"];
  const poolForest = ["goblin", "mushroom", "demon"];
  const poolDesert = ["mushroom", "octopus", "devil"];
  const poolMount = ["goblin", "devil", "dragon"];
  const poolWater = ["octopus", "mushroom"];
  const poolTown = []; // æ‘ãƒ»åŸã¯åŸå‰‡ã‚¨ãƒ³ã‚«ã‚¦ãƒ³ãƒˆãªã—
  const poolBossCastle = []; // ãƒœã‚¹åŸã¯ç‰¹åˆ¥å‡¦ç†

  let pool = poolGrass;
  if (tile === T.FOREST) pool = poolForest;
  if (tile === T.DESERT) pool = poolDesert;
  if (tile === T.MOUNTAIN) pool = poolMount;
  if (tile === T.WATER) pool = poolWater;
  if (tile === T.VILLAGE || tile === T.CASTLE) pool = poolTown;
  if (tile === T.BOSS_CASTLE) pool = poolBossCastle;

  if (pool.length === 0) return null;
  const id = pool[Math.floor(Math.random() * pool.length)];
  return { ...ENEMIES[id] }; // ã‚³ãƒ”ãƒ¼
}

// ã‚¨ãƒ³ã‚«ã‚¦ãƒ³ãƒˆç‡ï¼ˆåœ°å½¢åˆ¥ï¼‰
function getEncounterRate(tile) {
  switch (tile) {
    case T.GRASS: return 0.14;
    case T.FOREST: return 0.22;
    case T.DESERT: return 0.18;
    case T.MOUNTAIN: return 0.12;
    case T.WATER: return 0.06;
    case T.VILLAGE: return 0.00;
    case T.CASTLE: return 0.00;
    case T.BOSS_CASTLE: return 0.00; // ãƒœã‚¹åŸã¯ç‰¹åˆ¥å‡¦ç†
    default: return 0.12;
  }
}

// æˆ¦é—˜é–‹å§‹
function startBattle(tile) {
  // ã¾ãšãƒœã‚¹ãƒã‚§ãƒƒã‚¯
  const boss = getBossAtLocation();
  if (boss) {
    // ãƒœã‚¹æˆ¦é–‹å§‹
    inBattle = true;
    isBossBattle = true;
    enemy = boss;
    
    showBattleUI(true);
    enemyArea.textContent = `${enemy.name} ãŒç«‹ã¡ã¯ã ã‹ã‚‹ï¼`;
    enemySprite.innerHTML = ENEMY_SVG[enemy.id] || "";
    enemyStatus.textContent = `HP:${enemy.hp}/${enemy.maxHp}`;
    updatePlayerStatus();
    setLog(`é­”ç‹ ${enemy.name} ã¨ã®æ±ºæˆ¦ã ï¼`);
    return;
  }

  // é€šå¸¸ã®æ•µ
  const e = pickEnemyByTile(tile);
  if (!e) return; // æ‘ãƒ»åŸãªã©
  inBattle = true;
  isBossBattle = false;
  enemy = e;

  showBattleUI(true);
  enemyArea.textContent = `${enemy.name} ãŒã‚ã‚‰ã‚ã‚ŒãŸï¼`;
  enemySprite.innerHTML = ENEMY_SVG[enemy.id] || "";
  enemyStatus.textContent = `HP:${enemy.hp}`;
  updatePlayerStatus();
  setLog(`${enemy.name} ãŒ ã‚ã‚‰ã‚ã‚ŒãŸï¼`);
}

// æˆ¦é—˜çµ‚äº†
function endBattle(message) {
  setLog(message);
  setTimeout(() => {
    inBattle = false;
    enemy = null;
    showBattleUI(false);
    drawMap(); // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¾©å¸°
    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¾©å¸°å¾Œã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
    setLog(FIELD_MESSAGE);
  }, 1200);
}

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ»æ•µã®ã‚¿ãƒ¼ãƒ³
function playerAttack() {
  if (!inBattle) return;
  const dmg = Math.max(1, player.atk - (enemy.def || 0) + Math.floor(Math.random() * 4));
  enemy.hp -= dmg;
  setLog(`ã‚†ã†ã—ã‚ƒã® ã“ã†ã’ãï¼ ${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
  
  if (isBossBattle) {
    enemyStatus.textContent = `HP:${Math.max(0, enemy.hp)}/${enemy.maxHp}`;
  } else {
    enemyStatus.textContent = `HP:${Math.max(0, enemy.hp)}`;
  }
  
  if (enemy.hp <= 0) {
    player.exp += enemy.exp;
    player.gold += enemy.gold;
    
    // ãƒœã‚¹æ’ƒç ´æ™‚ã®å‡¦ç†
    if (isBossBattle) {
      player.defeatedBosses.push(enemy.id);
      setLog(`${enemy.name} ã‚’è¨ä¼ã—ãŸï¼ï¼`);
    }
    
    levelUpCheck();
    updatePlayerStatus();
    endBattle(`${enemy.name} ã‚’ ãŸãŠã—ãŸï¼`);
    return;
  }
  setTimeout(enemyAttack, 800);
}

function playerMagic() {
  if (!inBattle) return;
  if (player.mp < 3) {
    setLog("MPãŒ ãŸã‚Šãªã„ï¼");
    return;
  }
  player.mp -= 3;
  const dmg = 6 + Math.floor(Math.random() * 4);
  enemy.hp -= dmg;
  setLog(`ãƒ›ã‚¤ãƒŸï¼ ${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
  
  if (isBossBattle) {
    enemyStatus.textContent = `HP:${Math.max(0, enemy.hp)}/${enemy.maxHp}`;
  } else {
    enemyStatus.textContent = `HP:${Math.max(0, enemy.hp)}`;
  }
  
  updatePlayerStatus();
  if (enemy.hp <= 0) {
    player.exp += enemy.exp;
    player.gold += enemy.gold;
    
    // ãƒœã‚¹æ’ƒç ´æ™‚ã®å‡¦ç†
    if (isBossBattle) {
      player.defeatedBosses.push(enemy.id);
      setLog(`${enemy.name} ã‚’è¨ä¼ã—ãŸï¼ï¼`);
    }
    
    levelUpCheck();
    updatePlayerStatus();
    endBattle(`${enemy.name} ã¯ ããˆã•ã£ãŸï¼`);
    return;
  }
  setTimeout(enemyAttack, 800);
}

function playerRun() {
  if (!inBattle) return;
  
  // ãƒœã‚¹ã‹ã‚‰ã¯é€ƒã’ã‚‰ã‚Œãªã„
  if (isBossBattle) {
    setLog(`${enemy.name} ã¯é€ƒãŒã—ã¦ãã‚Œãªã„ï¼`);
    setTimeout(enemyAttack, 700);
    return;
  }
  
  if (Math.random() < 0.6) {
    endBattle("ã†ã¾ã ã«ã’ãã‚ŒãŸï¼");
  } else {
    setLog("ã«ã’ã‚‰ã‚Œãªã„ï¼");
    setTimeout(enemyAttack, 700);
  }
}

function enemyAttack() {
  if (!inBattle || !enemy) return;
  
  // ãƒœã‚¹ã®ç‰¹æ®Šæ”»æ’ƒåˆ¤å®š
  if (isBossBattle && Math.random() < 0.3) {
    const specialDmg = Math.max(1, enemy.specialDamage - player.def + Math.floor(Math.random() * 3));
    player.hp -= specialDmg;
    if (player.hp < 0) player.hp = 0;
    setLog(`${enemy.name} ã® ${enemy.specialAttack}ï¼ ${specialDmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
  } else {
    const dmg = Math.max(1, enemy.atk - player.def + Math.floor(Math.random() * 3));
    player.hp -= dmg;
    if (player.hp < 0) player.hp = 0;
    setLog(`${enemy.name} ã® ã“ã†ã’ãï¼ ${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
  }
  
  updatePlayerStatus();
  if (player.hp <= 0) {
    endBattle("ã‚†ã†ã—ã‚ƒã¯ ãŸãŠã‚ŒãŸâ€¦");
    // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†å¯èƒ½
    setTimeout(() => {
      player.hp = player.maxHp;
      player.mp = player.maxMp;
      player.x = 2;
      player.y = 2;
      mapRow = 0;
      mapCol = 0;
      mapData = WORLD[mapRow][mapCol];
      updatePlayerStatus();
      drawMap();
      setLog("ã‚Šã‚…ã†ãŠã†ã®åŸã§ ç›®ã‚’è¦šã¾ã—ãŸâ€¦");
    }, 2000);
  }
}

// ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—
function levelUpCheck() {
  if (player.exp >= player.nextExp) {
    player.level++;
    player.exp = 0;
    player.nextExp += 20;
    player.maxHp += 6;
    player.maxMp += 2;
    player.atk += 2;
    player.def += 1;
    player.hp = player.maxHp;
    player.mp = player.maxMp;
    setLog("ãƒ¬ãƒ™ãƒ«ãŒ ã‚ãŒã£ãŸï¼");
    updatePlayerStatus();
  }
}

function updatePlayerStatus() {
  goldValue.textContent = player.gold;
  expValue.textContent = player.exp;
  levelValue.textContent = player.level;
  hpValue.textContent = player.hp;
  maxHpValue.textContent = player.maxHp;
  mpValue.textContent = player.mp;
  maxMpValue.textContent = player.maxMp;
}

// --------- å»ºç‰©å†…éƒ¨ã®çŠ¶æ…‹ç®¡ç† ---------
let inBuilding = false;
let currentBuilding = null;

// å»ºç‰©å†…éƒ¨ç”»é¢ã®æç”»
function drawBuildingInterior(buildingType) {
  console.log("å»ºç‰©å†…éƒ¨æç”»é–‹å§‹:", buildingType);
  if (!ctx) return;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  switch(buildingType) {
    case T.VILLAGE:
      console.log("æ‘ã®å†…éƒ¨ã‚’æç”»");
      // æ‘ã®å†…éƒ¨ï¼ˆèŒ¶è‰²ã®åºŠã€æœ¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
      ctx.fillStyle = "#8b4513";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // æœ¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«
      ctx.fillStyle = "#654321";
      ctx.fillRect(120, 120, 80, 80);
      
      // æ‘äººï¼ˆç·‘è‰²ã®äººï¼‰
      ctx.fillStyle = "#228b22";
      ctx.fillRect(140, 80, 40, 60);
      ctx.fillStyle = "#ffdbac";
      ctx.fillRect(150, 70, 20, 20);
      
      // æ–‡å­—è¡¨ç¤º
      ctx.fillStyle = "#ffffff";
      ctx.font = "12px monospace";
      ctx.fillText("æ‘ã®å®¿å±‹", 130, 40);
      break;
      
    case T.CASTLE:
      console.log("åŸã®å†…éƒ¨ã‚’æç”»");
      // åŸã®å†…éƒ¨ï¼ˆçŸ³ã®åºŠã€ç‹åº§ï¼‰
      ctx.fillStyle = "#696969";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // ç‹åº§
      ctx.fillStyle = "#ffd700";
      ctx.fillRect(140, 100, 60, 80);
      ctx.fillRect(130, 90, 80, 20);
      
      // ç‹æ§˜ï¼ˆé’ã„ãƒãƒ³ãƒˆï¼‰
      ctx.fillStyle = "#0000ff";
      ctx.fillRect(150, 60, 40, 60);
      ctx.fillStyle = "#ffdbac";
      ctx.fillRect(160, 50, 20, 20);
      ctx.fillStyle = "#ffd700";
      ctx.fillRect(155, 45, 30, 10);
      
      // æ–‡å­—è¡¨ç¤º
      ctx.fillStyle = "#ffffff";
      ctx.font = "12px monospace";
      ctx.fillText("ç‹ã®é–“", 140, 40);
      break;
      
    case T.BOSS_CASTLE:
      console.log("é­”ç‹åŸã®å†…éƒ¨ã‚’æç”»");
      // é­”ç‹åŸã®å†…éƒ¨ï¼ˆæš—ã„ã€ä¸æ°—å‘³ï¼‰
      ctx.fillStyle = "#1a0000";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // é­”ç‹ã®ç‰åº§
      ctx.fillStyle = "#330000";
      ctx.fillRect(120, 100, 80, 100);
      
      // ç‚ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
      for (let i = 0; i < 10; i++) {
        ctx.fillStyle = `rgba(255, ${100 + Math.random() * 100}, 0, 0.7)`;
        ctx.fillRect(50 + Math.random() * 220, 200 + Math.random() * 100, 20, 20);
      }
      
      // æ–‡å­—è¡¨ç¤º
      ctx.fillStyle = "#ff0000";
      ctx.font = "14px monospace";
      ctx.fillText("é­”ç‹ã®é–“", 120, 40);
      break;
      
    default:
      console.log("ä¸æ˜ãªå»ºç‰©ã‚¿ã‚¤ãƒ—:", buildingType);
      ctx.fillStyle = "#000000";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#ffffff";
      ctx.font = "12px monospace";
      ctx.fillText("ä¸æ˜ãªå ´æ‰€", 120, 40);
      break;
  }
  
  // å‡ºå£ã®è¡¨ç¤º
  ctx.fillStyle = "#ffffff";
  ctx.font = "10px monospace";
  ctx.fillText("â†“å‡ºå£", 150, 300);
  console.log("å»ºç‰©å†…éƒ¨æç”»å®Œäº†");
}

// å»ºç‰©ã‹ã‚‰å‡ºã‚‹å‡¦ç†
function exitBuilding() {
  if (!inBuilding) return;
  
  inBuilding = false;
  currentBuilding = null;
  drawMap(); // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒãƒƒãƒ—ã«æˆ»ã‚‹
  setLog("å¤–ã«å‡ºãŸã€‚");
}
function enterBuilding(tile) {
  console.log("å»ºç‰©ã«å…¥å ´:", tile, "ä½ç½®:", mapRow, mapCol, player.x, player.y); // ãƒ‡ãƒãƒƒã‚°ç”¨
  
  switch(tile) {
    case T.VILLAGE:
      setLog("æ‘äººã€Œã„ã‚‰ã£ã—ã‚ƒã„ï¼ã“ã“ã¯å¹³å’Œãªæ‘ã§ã™ã€‚ã€");
      // æ‘ã®æ©Ÿèƒ½ï¼ˆã‚¢ã‚¤ãƒ†ãƒ è³¼å…¥ã€æƒ…å ±åé›†ãªã©ï¼‰
      setTimeout(() => {
        const choice = Math.random();
        if (choice < 0.3) {
          setLog("æ‘äººã€Œè–¬è‰ã‚’50ã‚´ãƒ¼ãƒ«ãƒ‰ã§å£²ã£ã¦ã‚ã’ã‚ˆã†ã€‚ã€");
          setTimeout(() => {
            if (player.gold >= 50) {
              player.gold -= 50;
              player.hp = Math.min(player.maxHp, player.hp + 20);
              updatePlayerStatus();
              setLog("è–¬è‰ã‚’è²·ã£ãŸï¼HPãŒ20å›å¾©ã—ãŸï¼");
            } else {
              setLog("ãŠé‡‘ãŒè¶³ã‚Šãªã„â€¦");
            }
          }, 1000);
        } else if (choice < 0.6) {
          setLog("æ‘äººã€Œé­”ç‹åŸã¯æã‚ã—ã„å ´æ‰€ã ã€‚æ°—ã‚’ã¤ã‘ã¦ï¼ã€");
        } else {
          setLog("æ‘äººã€Œãƒ¬ãƒ™ãƒ«ã‚’ä¸Šã’ã¦ç‰©ç†ã§æ®´ã‚‹ã®ã˜ã‚ƒï¼ã€");
        }
      }, 1000);
      break;
      
    case T.CASTLE:
      setLog("å…µå£«ã€Œã“ã“ã¯ç‹ã®åŸã§ã™ã€‚å‹‡è€…ã‚ˆã€ä¸–ç•Œã‚’æ•‘ã£ã¦ãã ã•ã„ï¼ã€");
      setTimeout(() => {
        // åŸã®æ©Ÿèƒ½ï¼ˆå…¨å›å¾©ã€ã‚»ãƒ¼ãƒ–ãªã©ï¼‰
        player.hp = player.maxHp;
        player.mp = player.maxMp;
        updatePlayerStatus();
        setLog("ç‹ã€Œå‹‡è€…ã‚ˆï¼HPã¨MPã‚’å…¨å›å¾©ã—ã¦ã‚„ã‚ã†ï¼ã€");
      }, 1000);
      break;
      
    case T.BOSS_CASTLE:
      console.log("é­”ç‹åŸã«å…¥å ´"); // ãƒ‡ãƒãƒƒã‚°ç”¨
      const boss = getBossAtLocation();
      if (boss) {
        console.log("ãƒœã‚¹æˆ¦é–‹å§‹:", boss.name); // ãƒ‡ãƒãƒƒã‚°ç”¨
        setLog("æã‚ã—ã„ã‚ªãƒ¼ãƒ©ãŒç«‹ã¡ã“ã‚ã¦ã„ã‚‹â€¦");
        setTimeout(() => {
          startBattle(tile);
        }, 1000);
      } else {
        console.log("ãƒœã‚¹ãªã— - å»ƒå¢Ÿ"); // ãƒ‡ãƒãƒƒã‚°ç”¨
        setLog("é™å¯‚ã«åŒ…ã¾ã‚ŒãŸå»ƒå¢Ÿã®åŸâ€¦ã‚‚ã†ä½•ã‚‚ãªã„ã€‚");
      }
      break;
  }
}
function movePlayer(dx, dy) {
  if (inBattle) return;

  let nx = player.x + dx;
  let ny = player.y + dy;

  // ç«¯ã§ãƒãƒƒãƒ—åˆ‡æ›¿
  if (nx < 0) {
    if (mapCol > 0) {
      mapCol--;
      mapData = WORLD[mapRow][mapCol];
      nx = MAP_W - 1;
    } else return;
  } else if (nx >= MAP_W) {
    if (mapCol < WORLD[0].length - 1) {
      mapCol++;
      mapData = WORLD[mapRow][mapCol];
      nx = 0;
    } else return;
  }

  if (ny < 0) {
    if (mapRow > 0) {
      mapRow--;
      mapData = WORLD[mapRow][mapCol];
      ny = MAP_H - 1;
    } else return;
  } else if (ny >= MAP_H) {
    if (mapRow < WORLD.length - 1) {
      mapRow++;
      mapData = WORLD[mapRow][mapCol];
      ny = 0;
    } else return;
  }

  // åæ˜ 
  player.x = nx;
  player.y = ny;
  drawMap();

  // ãƒœã‚¹åŸãƒã‚§ãƒƒã‚¯
  const tile = mapData[player.y][player.x];
  if (tile === T.BOSS_CASTLE) {
    const boss = getBossAtLocation();
    if (boss) {
      startBattle(tile);
      return;
    } else {
      setLog("ã“ã“ã«ã¯ ã‚‚ã†ä½•ã‚‚ãªã„â€¦");
      return;
    }
  }

  // ã‚¨ãƒ³ã‚«ã‚¦ãƒ³ãƒˆåˆ¤å®šï¼ˆåœ°å½¢ä¾å­˜ï¼‰
  const rate = getEncounterRate(tile);
  if (Math.random() < rate) startBattle(tile);
}

// --------- å…¥åŠ›ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç›´æ¥å®Ÿè£…ç‰ˆï¼‰ ---------
document.addEventListener("keydown", (e) => {
  console.log("ğŸ® ã‚­ãƒ¼æŠ¼ä¸‹:", e.key);
  
  // æˆ¦é—˜ä¸­ã¯ç§»å‹•ä¸å¯
  if (inBattle) {
    console.log("âŒ æˆ¦é—˜ä¸­ã®ãŸã‚ç§»å‹•ä¸å¯");
    return;
  }

  // å»ºç‰©å†…ã®å‡¦ç†
  if (inBuilding) {
    console.log("ğŸ  å»ºç‰©å†…ã§ã®å‡¦ç†");
    if (e.key === "ArrowDown") {
      console.log("ğŸšª å»ºç‰©ã‹ã‚‰é€€å‡º");
      inBuilding = false;
      currentBuilding = null;
      drawMap();
      setLog("å¤–ã«å‡ºãŸã€‚");
    }
    return;
  }

  let dx = 0, dy = 0;
  
  if (e.key === "ArrowUp") {
    e.preventDefault();
    dy = -1;
    console.log("â¬†ï¸ ä¸Šç§»å‹•é–‹å§‹");
  } else if (e.key === "ArrowDown") {
    e.preventDefault();
    dy = 1;
    console.log("â¬‡ï¸ ä¸‹ç§»å‹•é–‹å§‹");
  } else if (e.key === "ArrowLeft") {
    e.preventDefault();
    dx = -1;
    console.log("â¬…ï¸ å·¦ç§»å‹•é–‹å§‹");
  } else if (e.key === "ArrowRight") {
    e.preventDefault();
    dx = 1;
    console.log("â¡ï¸ å³ç§»å‹•é–‹å§‹");
  } else {
    return; // çŸ¢å°ã‚­ãƒ¼ä»¥å¤–ã¯ç„¡è¦–
  }

  console.log("ğŸ“ ç§»å‹•å‰ã®ä½ç½®:", player.x, player.y, "ãƒãƒƒãƒ—:", mapRow, mapCol);

  // æ–°ã—ã„ä½ç½®ã‚’è¨ˆç®—
  let newX = player.x + dx;
  let newY = player.y + dy;
  let newMapRow = mapRow;
  let newMapCol = mapCol;

  console.log("ğŸ¯ è¨ˆç®—å¾Œã®ä½ç½®:", newX, newY);

  // ãƒãƒƒãƒ—å¢ƒç•Œãƒã‚§ãƒƒã‚¯
  if (newX < 0) {
    console.log("â¬…ï¸ å·¦å¢ƒç•Œãƒã‚§ãƒƒã‚¯");
    if (mapCol > 0) {
      newMapCol = mapCol - 1;
      newX = MAP_W - 1;
      console.log("âœ… å·¦ãƒãƒƒãƒ—ã¸:", newMapRow, newMapCol);
    } else {
      console.log("âŒ å·¦ç«¯ã§ç§»å‹•ä¸å¯");
      return;
    }
  } else if (newX >= MAP_W) {
    console.log("â¡ï¸ å³å¢ƒç•Œãƒã‚§ãƒƒã‚¯");
    if (mapCol < WORLD[0].length - 1) {
      newMapCol = mapCol + 1;
      newX = 0;
      console.log("âœ… å³ãƒãƒƒãƒ—ã¸:", newMapRow, newMapCol);
    } else {
      console.log("âŒ å³ç«¯ã§ç§»å‹•ä¸å¯");
      return;
    }
  }

  if (newY < 0) {
    console.log("â¬†ï¸ ä¸Šå¢ƒç•Œãƒã‚§ãƒƒã‚¯");
    if (mapRow > 0) {
      newMapRow = mapRow - 1;
      newY = MAP_H - 1;
      console.log("âœ… ä¸Šãƒãƒƒãƒ—ã¸:", newMapRow, newMapCol);
    } else {
      console.log("âŒ ä¸Šç«¯ã§ç§»å‹•ä¸å¯");
      return;
    }
  } else if (newY >= MAP_H) {
    console.log("â¬‡ï¸ ä¸‹å¢ƒç•Œãƒã‚§ãƒƒã‚¯");
    if (mapRow < WORLD.length - 1) {
      newMapRow = mapRow + 1;
      newY = 0;
      console.log("âœ… ä¸‹ãƒãƒƒãƒ—ã¸:", newMapRow, newMapCol);
    } else {
      console.log("âŒ ä¸‹ç«¯ã§ç§»å‹•ä¸å¯");
      return;
    }
  }

  // ä½ç½®æ›´æ–°
  player.x = newX;
  player.y = newY;
  mapRow = newMapRow;
  mapCol = newMapCol;
  mapData = WORLD[mapRow][mapCol];

  console.log("âœ… ç§»å‹•å®Œäº†:", player.x, player.y, "ãƒãƒƒãƒ—:", mapRow, mapCol);

  // ãƒãƒƒãƒ—å†æç”»
  console.log("ğŸ—ºï¸ ãƒãƒƒãƒ—æç”»é–‹å§‹");
  drawMap();
  console.log("ğŸ—ºï¸ ãƒãƒƒãƒ—æç”»å®Œäº†");

  // ç¾åœ¨ã®ã‚¿ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
  const tile = mapData[player.y][player.x];
  console.log("ğŸ¯ ç¾åœ¨ã®ã‚¿ã‚¤ãƒ«:", tile);

  // å»ºç‰©ãƒã‚§ãƒƒã‚¯
  if (tile === T.VILLAGE) {
    console.log("ğŸ  æ‘ç™ºè¦‹ï¼");
    inBuilding = true;
    currentBuilding = tile;
    drawBuildingInterior(tile);
    setLog("æ‘äººã€Œã„ã‚‰ã£ã—ã‚ƒã„ï¼ã“ã“ã¯å¹³å’Œãªæ‘ã§ã™ã€‚ä¸‹çŸ¢å°ã§å¤–ã«å‡ºã‚‰ã‚Œã¾ã™ã€‚ã€");
    return;
  }
  
  if (tile === T.CASTLE) {
    console.log("ğŸ° åŸç™ºè¦‹ï¼");
    inBuilding = true;
    currentBuilding = tile;
    drawBuildingInterior(tile);
    player.hp = player.maxHp;
    player.mp = player.maxMp;
    updatePlayerStatus();
    setLog("ç‹ã€Œå‹‡è€…ã‚ˆï¼HPã¨MPã‚’å…¨å›å¾©ã—ã¦ã‚„ã‚ã†ï¼ä¸‹çŸ¢å°ã§å¤–ã«å‡ºã‚‰ã‚Œã¾ã™ã€‚ã€");
    return;
  }
  
  if (tile === T.BOSS_CASTLE) {
    console.log("ğŸ´ é­”ç‹åŸç™ºè¦‹ï¼");
    const boss = getBossAtLocation();
    if (boss) {
      console.log("ğŸ’€ ãƒœã‚¹æˆ¦é–‹å§‹!");
      startBattle(tile);
    } else {
      console.log("ğŸ‘» å»ƒå¢Ÿ");
      setLog("é™å¯‚ã«åŒ…ã¾ã‚ŒãŸå»ƒå¢Ÿã®åŸâ€¦ã‚‚ã†ä½•ã‚‚ãªã„ã€‚");
    }
    return;
  }

  // ã‚¨ãƒ³ã‚«ã‚¦ãƒ³ãƒˆåˆ¤å®š
  const rate = getEncounterRate(tile);
  const random = Math.random();
  console.log("âš”ï¸ ã‚¨ãƒ³ã‚«ã‚¦ãƒ³ãƒˆåˆ¤å®š:", rate, "vs", random);
  
  if (random < rate) {
    console.log("ğŸ’¥ ã‚¨ãƒ³ã‚«ã‚¦ãƒ³ãƒˆï¼");
    startBattle(tile);
  } else {
    console.log("âœ… å®‰å…¨");
  }

  console.log("ğŸ ç§»å‹•å‡¦ç†å®Œäº†");
});

// ã‚¹ãƒ¯ã‚¤ãƒ—
let touchSX = null, touchSY = null;
canvas.addEventListener("touchstart", (e) => {
  console.log("ã‚¿ãƒƒãƒé–‹å§‹");
  if (inBattle) return;
  const t = e.changedTouches[0];
  touchSX = t.clientX;
  touchSY = t.clientY;
}, { passive: true });

canvas.addEventListener("touchend", (e) => {
  console.log("ã‚¿ãƒƒãƒçµ‚äº†");
  if (inBattle) return;
  if (touchSX == null || touchSY == null) return;
  const t = e.changedTouches[0];
  const dx = t.clientX - touchSX;
  const dy = t.clientY - touchSY;
  console.log("ã‚¹ãƒ¯ã‚¤ãƒ—:", dx, dy);
  
  if (Math.abs(dx) > Math.abs(dy)) {
    if (dx > 30) {
      console.log("å³ã‚¹ãƒ¯ã‚¤ãƒ—");
      movePlayer(1, 0);
    } else if (dx < -30) {
      console.log("å·¦ã‚¹ãƒ¯ã‚¤ãƒ—");
      movePlayer(-1, 0);
    }
  } else {
    if (dy > 30) {
      console.log("ä¸‹ã‚¹ãƒ¯ã‚¤ãƒ—");
      movePlayer(0, 1);
    } else if (dy < -30) {
      console.log("ä¸Šã‚¹ãƒ¯ã‚¤ãƒ—");
      movePlayer(0, -1);
    }
  }
  touchSX = touchSY = null;
}, { passive: true });

// ç”»é¢ä¸Šã®è£œåŠ©ãƒœã‚¿ãƒ³
(function attachMobileDpad() {
  const pad = document.querySelectorAll(".dir-btn");
  console.log("æ–¹å‘ãƒœã‚¿ãƒ³æ•°:", pad.length);
  
  pad.forEach(b => {
    b.addEventListener("pointerdown", (e) => {
      e.preventDefault();
      const dir = b.dataset.dir;
      console.log("æ–¹å‘ãƒœã‚¿ãƒ³æŠ¼ä¸‹:", dir);
      
      if (dir === "up") movePlayer(0, -1);
      if (dir === "down") movePlayer(0, 1);
      if (dir === "left") movePlayer(-1, 0);
      if (dir === "right") movePlayer(1, 0);
    });
    
    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚‚è¿½åŠ 
    b.addEventListener("click", (e) => {
      e.preventDefault();
      const dir = b.dataset.dir;
      console.log("æ–¹å‘ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯:", dir);
      
      if (dir === "up") movePlayer(0, -1);
      if (dir === "down") movePlayer(0, 1);
      if (dir === "left") movePlayer(-1, 0);
      if (dir === "right") movePlayer(1, 0);
    });
  });
})();

// æˆ¦é—˜ã‚³ãƒãƒ³ãƒ‰
document.getElementById("attackBtn").addEventListener("click", () => {
  console.log("æ”»æ’ƒãƒœã‚¿ãƒ³æŠ¼ä¸‹");
  playerAttack();
});
document.getElementById("magicBtn").addEventListener("click", () => {
  console.log("é­”æ³•ãƒœã‚¿ãƒ³æŠ¼ä¸‹");
  playerMagic();
});
document.getElementById("runBtn").addEventListener("click", () => {
  console.log("é€ƒã’ã‚‹ãƒœã‚¿ãƒ³æŠ¼ä¸‹");
  playerRun();
});

// --------- ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ©Ÿèƒ½ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰ ---------
function showStatus() {
  const bossCount = player.defeatedBosses.length;
  setLog(`ã‚†ã†ã—ã‚ƒ LV.${player.level} HP:${player.hp}/${player.maxHp} MP:${player.mp}/${player.maxMp} ATK:${player.atk} DEF:${player.def} ãƒœã‚¹è¨ä¼æ•°:${bossCount}`);
}

function showItems() {
  setLog("ã©ã†ãã‚’ ã‚‚ã£ã¦ã„ãªã„ã€‚");
}

function showMagic() {
  setLog("ã‚²ãƒ³ã‚­ãƒƒã‚ºï¼ˆå›å¾©ã®å‘ªæ–‡ï¼‰ã‚’è¦šãˆã¦ã„ã‚‹ã€‚");
}

function saveGame() {
  setLog("ã¼ã†ã‘ã‚“ã®æ›¸ã« ãã‚ãã—ã¾ã—ãŸã€‚");
}

// --------- åˆæœŸæç”»ã¨ç¢ºèª ---------
console.log("=== ã‚²ãƒ¼ãƒ åˆæœŸåŒ–é–‹å§‹ ===");
console.log("movePlayeré–¢æ•°:", typeof movePlayer);

drawMap();
showBattleUI(false);
updatePlayerStatus();
setLog("å†’é™ºã®ä¸–ç•Œã¸ ã‚ˆã†ã“ãï¼é­”ç‹åŸã‚’æ¢ã›ï¼");

console.log("=== ã‚²ãƒ¼ãƒ åˆæœŸåŒ–å®Œäº† ===");

// movePlayeré–¢æ•°ã®ãƒ†ã‚¹ãƒˆå‘¼ã³å‡ºã—
console.log("movePlayeré–¢æ•°ãƒ†ã‚¹ãƒˆå‘¼ã³å‡ºã—");
setTimeout(() => {
  console.log("ãƒ†ã‚¹ãƒˆ: movePlayer(0, 0)ã‚’å‘¼ã³å‡ºã—");
  movePlayer(0, 0);
}, 1000);
  </script>
</body>
</html>_SIZE;
        const ry = py + Math.random() * TILE_SIZE;
        ctx.fillRect(rx, ry, 2, 2);
      }
      break;
    }
    case T.FOREST: {
      // å°ã•ãªä¸¸ã§æ¨¹æœ¨æ„Ÿ
      ctx.fillStyle = "#1d7a2b";
      for (let i = 0; i < 4; i++) {
        ctx.beginPath();
        ctx.arc(px + 16 + i * 8, py + 16 + (i * 12) % 32, 6, 0, Math.PI * 2);
        ctx.fill();
      }
      break;
    }
    case T.WATER: {
      // ã•ã–æ³¢
      ctx.strokeStyle = "#4da6ff";
      ctx.lineWidth = 2;
      for (let i = 0; i < 3; i++) {
        ctx.beginPath();
        ctx.moveTo(px + 8, py + 16 + i * 16);
        ctx.quadraticCurveTo(px + 32, py + 8 + i * 16, px + 56, py + 16 + i * 16);
        ctx.stroke();
      }
      break;
    }
    case T.DESERT: {
      // ç ‚æ¨¡æ§˜
      ctx.fillStyle = "rgba(139,69,19,0.3)";
      for (let i = 0; i < 12; i++) {
        const rx = px + Math.random() * TILE
